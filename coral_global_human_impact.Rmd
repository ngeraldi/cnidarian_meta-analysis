---
title: "coral_global_match_figs_124"
author: "Nathan R. Geraldi"
date: "October 2, 2019"
output: github_document
---

set table options
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## libraries

```{r Libraries}

library(lme4)
library(lmerTest)
library(dplyr)
library(tidyr)
library(RColorBrewer)   #   install.packages("RColorBrewer")
library(ggplot2)

# geo related 
library(mapdata)
library(ncdf4)  
library(raster)
library(stringr)
library(mregions) 
library(rgeos)
library(rgdal)
library(maps)
library(sf)


```

## functions
```{r funk}

### function to remove attributes appearing after scaling
one_entry <- function(x) {
  for (i in length(x)) attr(x[[i]], "names") <- NULL
  return(x)
}

## to change location and size of legend in ggplot

change_legend <- function(myPlot, pointSize = 2, textSize = 9, spaceLegend = 0.1) {
    myPlot +
        guides(#fill = guide_legend(override.aes = list(size = pointSize)),
                fill = guide_colourbar(barwidth = 0.9, barheight = 4.0)) +
         #      color = guide_legend(override.aes = list(size = pointSize))) +
        theme(legend.position = c(0.44, 0.5), # center of legend
              legend.title = element_text(size = textSize), 
              legend.text  = element_text(size = textSize),
              plot.margin = unit(c(0.0,0,0.0,0), "lines") ) # top, right, bottom, left)
             # legend.key.size = unit(spaceLegend, "lines"))
}

# Apply on original plot
# change_legend(p)  change_legend(sst_r)
```

## universal variables
```{r directory}
#location of rater and shape files
rast_data<-"/Users/geraldn/Dropbox/Global_databases/"

## file to save plots
fig_file="/Users/geraldn/Dropbox/Cnidaria meta-data/Prod_2_glob/prod_2_plots"

## file that has data
dat_file="/Users/geraldn/Dropbox/Documents/KAUST/global change meta/R/export/"

```

## get data
meta-analysis data, and predictions from models
```{r data}
# Base layer for maps
base <- readOGR(dsn = paste(rast_data,"naturalearthdata/ne_110m_land",sep=""),
                layer = "ne_110m_land")  
base_sf <- sf::st_read(paste(rast_data,"naturalearthdata/ne_110m_land/ne_110m_land.shp",sep=""))
base_sf <- sf::st_transform( base_sf,"+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
base_sf_r <- st_wrap_dateline(base_sf, options = c("WRAPDATELINE=YES", "DATELINEOFFSET=180"), quiet = TRUE)


##  get Coral map super detailed, need, used coral from naturalearth data below
# coral_map <- readOGR(dsn = paste(rast_data,"data_unep_wcmc_coral_reef/DataPack-14_001_WCMC008_CoralReefs2010_v2/01_Data",sep=""), layer = "14_001_WCMC008_CoralReef2010_v2")   # 
 coral_map <- sf::st_read(paste(rast_data,"data_unep_wcmc_coral_reef/DataPack-14_001_WCMC008_CoralReefs2010_v2/01_Data/14_001_WCMC008_CoralReef2010_v2.shp",sep=""))
 
 coral_map <- sf::st_transform(  coral_map,"+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
 
 # summary(coral_map)  #  names(coral_map)
  coral_map_simp <- sf::st_read(paste(rast_data,"naturalearthdata/ne_10m_reefs/ne_10m_reefs.shp",sep=""))
    # plot(coral_map_simp, col="red", add=T)    
 
## get all data overlaid with coral reef map,  
 ###   from Global_extract_croal _poly.R 
reef_map_dat<-data.table::fread(file = paste(dat_file,"Global_CR_matchinfo.csv",sep=""), sep = ',', header = TRUE)
#  names(coral_map_dat)

##  get data by coral region, same as above??    remove yes
region_cr_map_dat<-data.table::fread(file =paste(dat_file,"Study_regions.csv",sep=""), header = TRUE)

##  get meta-analysis data
dat<-read.table(paste(dat_file,"data_for_analysis_withabiotic.csv",sep=""), sep=",",header=T)  

## get predicted data
 pred_warm_cat<-data.table::fread(file = paste(dat_file,"Global_CR_matchinfo_predict_warming_cat.csv",sep=""), header=T, sep=",") # names( pred_warm_cat)
  # back transform predicted
 pred_warm_cat <- pred_warm_cat %>% 
  mutate(chla_predict_yi=(exp(abs(chla_predict)))-1) %>%
  mutate(chla_predict_yi=if_else(chla_predict<0,(chla_predict_yi*-1), chla_predict_yi)) %>% 
     mutate(pam_predict_yi=(exp(abs(pam_predict)))-1) %>%
  mutate(pam_predict_yi=if_else(pam_predict<0,(pam_predict_yi*-1), pam_predict_yi)) %>% 
   mutate(resp_predict_yi=(exp(abs(resp_predict)))-1) %>%
  mutate(resp_predict_yi=if_else(resp_predict<0,(resp_predict_yi*-1), resp_predict_yi)) 

  pred_warm_all<-data.table::fread(file = paste(dat_file,"Global_CR_matchinfo_predict_warming_all.csv",sep=""), header=T, sep=",")  # names(pred_warm_all)
    # back transform predicted
 pred_warm_all <- pred_warm_all %>% 
  mutate(warm_all_predict_yi=(exp(abs(warm_all_predict)))-1) %>%
  mutate(warm_all_predict_yi=if_else(warm_all_predict<0,(warm_all_predict_yi*-1), warm_all_predict_yi)) 
 
```


## tidy 1
```{r tidy_1}
#  
### tidy data
names(dat)
sdat<- dat %>% 
  mutate(unique_study_loc=paste(Original.ref.number,latitude..decimal.degrees., longitude..decimal.degrees., sep="_")) %>% 
   filter(Taxa=="Calcifying coral")  %>%  ##  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   filter(Deep.sea.=="No" | is.na(Deep.sea.)) %>%  ##  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   filter(latitude..decimal.degrees. < 33 & latitude..decimal.degrees. > -33) %>%  ##  !!!!!!!!!!!!!!!!!!!!!
  filter(!is.na(unique_study_loc)) 
## filters to match statistics
sdat$yi<-sdat$AE_9eV_temp_pos_response  # sdat$AE_9eV_temp  #  class(sdat$yi)      names(sdat)
sdat$vi<-sdat$AE_9eV_temp_variation
target<-"warming"  # unique(sdat$Stressors.studied_study)---  acidification both warming
minchange<-1  # set minimum change between control and exp
maxyi<-15   #  set maximum yi, will remove everything larger

dat2<- sdat %>% 
  filter(Stressors.studied_study==target & complete.cases(Stressors.studied_study)) %>% 
  filter(complete.cases(yi))  %>% 
  filter(!is.infinite(yi)) %>% 
  filter(temp_change > minchange)  %>%    # as suggested by Carlos
  filter(abs(yi)<= maxyi) %>%  #15?  25 works    hist(sdat$AE_9eV_temp)
  mutate(yit=log(abs(yi)+1)) %>%   # get log transform o yi
  mutate(yi_log=if_else(yi<0,(yit*-1), yit))

### tidy data to remove catagories not used, then used to plot each factor level
## factor - variable.label.fix.2 for catagories  levels(dat2$variable.label.fix.2)
dat_cat<- dat2 %>% 
  filter(variable.label.fix.2 != "other") %>% 
  filter(variable.label.fix.2 != "calcification") %>% 
  filter(variable.label.fix.2 != "growth") %>% 
  mutate(variable.label.fix.2=recode(variable.label.fix.2, bleaching="symbiont density")) %>% 
  mutate(variable.label.fix.2=factor(variable.label.fix.2))

##################################################################################################
## tidy   spatial data 
###  add data to coral poly   names(pred_warm_cat)   names(pred_warm_all)
 # columns to append to shapefile     names(coral_map)
 coral_map <- coral_map %>% 
   left_join(pred_warm_cat[,c(1,3,4,50,59,65,70:85,6,8)], by = c("LAYER_ID" = "ID11")) %>% 
   left_join(pred_warm_all[,c(1,81:82)], by = c("LAYER_ID" = "ID11")) %>% 
   mutate(ltmax_change_2050=X2050AOGCM.RCP45.Surface.Temperature.Lt.max.asc11- Present.Surface.Temperature.Lt.max.asc11) %>% 
   mutate(ltmax_change_2100=X2100AOGCM.RCP45.Surface.Temperature.Lt.max.asc11- Present.Surface.Temperature.Lt.max.asc11) %>% 
   # standardize, then subtract
   mutate(sltmax_change_2050=scale(ltmax_change_2050),sltmax_change_2100=scale(ltmax_change_2100), 
          swarm_all_predict=scale(warm_all_predict)  ) %>% 
   mutate(vuln_2050=sltmax_change_2050+swarm_all_predict ,vuln_2100=sltmax_change_2100+swarm_all_predict) 

 
attributes(coral_map$sltmax_change_2050) <- NULL 
attributes(coral_map$sltmax_change_2100) <- NULL 
attributes(coral_map$swarm_all_predict) <- NULL 

 ### fine-scale coral to broader shape to plot use mean, aggregate (base) but uses sf package 
 ##   https://geocompr.robinlovelace.net/spatial-operations.html
coral_map_simp1 <- aggregate(x =  coral_map, by = coral_map_simp, FUN = mean)
 
```


### map_w_frequ_old
```{r map, eval=FALSE, include=FALSE}
 ##########       map with latitude frequnce      #############################
#?     library(mgcv) #  ,mar=c(4,6.5,0,0)
#par(mfcol=c(1,1), mar=c(.5,.5,.5,.5),mar=c(0,0,0,0),oma=c(0,2,0,0))#(bottom, left, top, right)  ## messes up projection
par(mar=c(.5,1,0,0),xpd=F)  # F hsould stop plot outside
map("worldHires",xlim = c(-180,180), ylim = c(-35,35),fill=T,col="gray", border=F,
     xpd = F,cex.lab=1, mar=c(.5,8,0,0))
map.axes(lty=1.2)
plot(coral_map,col=coral_col, border=coral_col, lwd=.7,add=T)    # ,add=T

points(data_pt$longitude..decimal.degrees., data_pt$latitude..decimal.degrees., 
        pch=1, cex=.4 , lwd = .5)
mtext("Longitude", SOUTH<-1, line=-5.5, adj=.42,outer=TRUE,cex=1)
mtext("Latitude", WEST<-2, line=-1.2, adj=0.5,outer=TRUE,cex=1)
par(fig=c(0.83,1,0.237,0.765), mar=c(0,.5,0,1), new=TRUE)
h<-hist(data1$latitude..decimal.degrees.,plot=F)
hh<-c(0,0,0,h$counts,0)  #  c(0,0,h$counts,0)
barplot(hh,width=1,horiz=T, beside=T,xlim=c(0,100),
        space=0, las=1)   # names.arg = hh$mids
axis(side=2, at=c(2,7,12), labels=c(-50,0,50),las=0)
box(lty=1.2)
mtext("Locations", SOUTH<-1, line=-5.5, adj=.95,outer=TRUE,cex=1)

#       dev.off() 
##  for checking
#  barplot(hh,width=1,horiz=T, beside=T,xlim=c(0,100),
#        space=0, las=1, names.arg = h$mids)   
```


## sig stats

```{r stat}
## prep
 stat_dat<- dat2 %>% #  names(dat2)
   mutate(O2_range=Present.Surface.Dissolved.oxygen.Lt.max-Present.Surface.Dissolved.oxygen.Lt.min)  %>% 
    mutate(sPresent.Surface.Temperature.Range=scale(Present.Surface.Temperature.Range),
           syrange=scale(yrange),
           sPresent.Surface.Temperature.Lt.max=scale(Present.Surface.Temperature.Lt.max),
           scoral_region_coral_richness=scale(coral_region_coral_richness), 
           ssstanom=scale(sstanom),
           smsec_humanpop_50km=scale(msec_humanpop_50km),  # hist(sdat$msec_humanpop_50km)
           svel_linear_change=scale(vel_linear_change))
 ## all temp      # hist(stat_dat$yi_log)    summary(all_stat) MuMIn::r.squaredGLMM(all_stat) 
 all_stat<-lmer(yi_log~sPresent.Surface.Temperature.Range
               +syrange
               +sPresent.Surface.Temperature.Lt.max
               +scoral_region_coral_richness 
               +ssstanom
               +smsec_humanpop_50km
               +svel_linear_change
               +sPresent.Surface.Temperature.Lt.max:ssstanom
               + (1|PROVINCE/Original.ref.number)+(1|Genus),
               weights=1/vi , data= stat_dat)
### chla 
 chla_dat<-stat_dat %>%   # hist(mdat$yi)
    filter(variable.label.fix.2=="chla")  %>% 
    mutate(sPresent.Surface.Temperature.Range=scale(Present.Surface.Temperature.Range),
       syrange=scale(yrange),
       sPresent.Surface.Temperature.Lt.max=scale(Present.Surface.Temperature.Lt.max),
       scoral_region_coral_richness=scale(coral_region_coral_richness), 
       ssstanom=scale(sstanom),
       smsec_humanpop_50km=scale(msec_humanpop_50km),  # hist(sdat$msec_humanpop_50km)
       svel_linear_change=scale(vel_linear_change))
 
 chla_stat<-lmer(yi_log~sPresent.Surface.Temperature.Range
               +syrange
               +sPresent.Surface.Temperature.Lt.max
               +scoral_region_coral_richness 
               +ssstanom
               +smsec_humanpop_50km
               +svel_linear_change
               + (1|PROVINCE/Original.ref.number)+(1|Genus),  # PROVINCE/
               weights=1/vi,  data=chla_dat)  # summary(sym_stat)
 ### pam 
 pam_dat<-stat_dat %>%   # hist(mdat$yi)
    filter(variable.label.fix.2=="pam")  %>% 
    mutate(sPresent.Surface.Temperature.Range=scale(Present.Surface.Temperature.Range),
       syrange=scale(yrange),
       sPresent.Surface.Temperature.Lt.max=scale(Present.Surface.Temperature.Lt.max),
       scoral_region_coral_richness=scale(coral_region_coral_richness), 
       ssstanom=scale(sstanom),
       smsec_humanpop_50km=scale(msec_humanpop_50km),  # hist(sdat$msec_humanpop_50km)
       svel_linear_change=scale(vel_linear_change))
 
 pam_stat<-lmer(yi_log~sPresent.Surface.Temperature.Range
               +syrange
               +sPresent.Surface.Temperature.Lt.max
               +scoral_region_coral_richness 
               +ssstanom
               +smsec_humanpop_50km
               +svel_linear_change
               +sPresent.Surface.Temperature.Range:ssstanom
               + (1|PROVINCE/Original.ref.number)+(1|Genus),  # PROVINCE/
               weights=1/vi,  data=pam_dat)  # summary(sym_stat)
 ### resp 
 resp_dat<-stat_dat %>%   # hist(sqrt(mdat$yi+1))  best
    filter(variable.label.fix.2=="respiration")  %>% 
    mutate(sPresent.Surface.Temperature.Range=scale(Present.Surface.Temperature.Range),
       syrange=scale(yrange),
       sPresent.Surface.Temperature.Lt.max=scale(Present.Surface.Temperature.Lt.max),
       scoral_region_coral_richness=scale(coral_region_coral_richness), 
       ssstanom=scale(sstanom),
       smsec_humanpop_50km=scale(msec_humanpop_50km),  
       svel_linear_change=scale(vel_linear_change))
 
 resp_stat<-lmer(yi_log~sPresent.Surface.Temperature.Range
               +syrange
               +sPresent.Surface.Temperature.Lt.max
               +scoral_region_coral_richness 
               +ssstanom
               + smsec_humanpop_50km
               +svel_linear_change
               + (1|PROVINCE/Original.ref.number)+(1|Genus)  
               , weights=1/vi ,  data=resp_dat)


```


## stats plot warm
plot significant variables from model of all warming data
then put in fig2-see later section
```{r stat_plot}
cc1<-"#d73027"
cc1<-"#84BDF0"

#########    warming
###   SST range
warm_sstr<-sjPlot::plot_model(all_stat, type = "pred", terms = "sPresent.Surface.Temperature.Range", title="",
                       axis.title = list("SST range (°C)", "Effect size"), show.data=TRUE)   # , show.data=TRUE
DMwR::unscale(c(-2,0,2), stat_dat$sPresent.Surface.Temperature.Range)
g_lab<-c(5,10,15)
g_num<- (g_lab - mean(stat_dat$Present.Surface.Temperature.Range, na.rm=T)) / sd(stat_dat$Present.Surface.Temperature.Range, na.rm=T)  
warm_sstr<-warm_sstr+ggpubr::rremove("grid")+
  scale_x_continuous(breaks=g_num, labels=g_lab)  # change x axis
###   SST max
warm_sstmax<-sjPlot::plot_model(all_stat, type = "pred", terms = "sPresent.Surface.Temperature.Lt.max", title="",
                       axis.title = list("SST max (°C)", "Effect size"))   # , show.data=TRUE
DMwR::unscale(c(-3,0,3), stat_dat$sPresent.Surface.Temperature.Lt.max)
g_lab<-c(26,29,32)
g_num<- (g_lab - mean(stat_dat$Present.Surface.Temperature.Lt.max, na.rm=T)) / sd(stat_dat$Present.Surface.Temperature.Lt.max, na.rm=T)  
warm_sstmax<-warm_sstmax+ggpubr::rremove("grid")+
  scale_x_continuous(breaks=g_num, labels=g_lab)  # change x axis
###   human
warm_human<-sjPlot::plot_model(all_stat, type = "pred", terms = "smsec_humanpop_50km", title="",
                       axis.title = list("Human population density (ind. within 50 km)", "Effect size"))   # , show.data=TRUE
DMwR::unscale(c(0,1,2), stat_dat$smsec_humanpop_50km)
g_lab<-c(400000,1500000,2500000)
g_num<- (g_lab - mean(stat_dat$msec_humanpop_50km, na.rm=T)) / sd(stat_dat$msec_humanpop_50km, na.rm=T)
g_lab<-c("400,000","1,500,000","2,500,000")
warm_human<-warm_human+ggpubr::rremove("grid")+
  scale_x_continuous(breaks=g_num, labels=g_lab)  # change x axis

###   sPresent.Surface.Temperature.Lt.max:ssstanom  interaction
warm_int<-sjPlot::plot_model(all_stat, type = "pred", terms = c("sPresent.Surface.Temperature.Lt.max", "ssstanom"),
                   mdrt.values = "meansd", legend.title="SST anomolies",title="", 
                   show.legend=F, show.data=TRUE, 
                   axis.title = list("SST max (°C)", "Effect size"),
                   colors = c("#74add1","#fee090","#d73027")      )
# xaxis
DMwR::unscale(c(-3,0,3), stat_dat$sPresent.Surface.Temperature.Lt.max)
g_lab<-c(25,29,33)
g_num<- (g_lab - mean(stat_dat$Present.Surface.Temperature.Lt.max, na.rm=T)) / sd(stat_dat$Present.Surface.Temperature.Lt.max, na.rm=T)  
# y axis
yn<-c(-2,0,2)  # from yaxis
yn2<-exp(abs(yn)) -1 # back transform  log(12)  hist(sym_dat$yilog)    exp(2.5) -15
yn3<-c(-6,0, 6)   # from back trasfrom choos nice label number
yn4<-log(abs(yn3)+1)        # get new locations from nice number
yn4[yn3<0]<-yn4[yn3<0]*-1
#legend 
DMwR::unscale(c(-1.04,0.04,1.11), stat_dat$ssstanom)
leg_lab<-c(.05,0.21,0.37)
# add legend and fix plot  --- only change r, nothing else
d=data.frame(x1=rep(-0.40,times=3), x2=rep(-0.1,times=3), y1=c(2.1,2.5,2.9), t=c("#74add1","#fee090","#d73027"), 
             r=leg_lab, xm=rep(0.2,times=3))
d$y2<-d$y1+0.30
d$ym<-(d$y1+d$y2)/2
qq<-1
warm_int <-  warm_int+ggpubr::rremove("grid")+
    scale_x_continuous(breaks=g_num, labels=g_lab) +  # change x axis
    scale_y_continuous(breaks=yn4, labels=yn3) +  # change y axis
    annotate("rect", xmin=d$x1, xmax=d$x2, ymin=d$y1, ymax=d$y2, alpha=0.5, fill=d$t)  +
    annotate("segment", x=d$x1, xend=d$x2, y=d$ym, yend=d$ym, colour=d$t)  +
    annotate("text", x=d$xm, y=d$ym, label=d$r, size=3) +
    annotate("text", x=d$x1[1]+0.3, y=d$y2[3]+0.25, label="SST anomolies", size=3) 
```


## stats plot cat
plot significant variables from models of catagories- chla, pam, and respiration
then put in fig2-see later section
```{r stat_pplot_cat}
#########   chla  -- 1 var
###   svel_linear_change
chla_sstch<-sjPlot::plot_model(chla_stat, type = "pred", terms = "svel_linear_change", title="",
                       axis.title = list("SST change (°C)", "Effect size") )   # , show.data=TRUE
DMwR::unscale(c(-1,1,3), chla_dat$svel_linear_change)
g_lab<-c(0.1,0.2,0.3)
g_num<- (g_lab - mean(chla_dat$vel_linear_change, na.rm=T)) / sd(chla_dat$vel_linear_change, na.rm=T)  
yn<-c(-2,0,2)  # from yaxis
yn2<-exp(abs(yn)) -1 # back transform  log(12)  hist(sym_dat$yilog)    exp(2.5) -15
yn3<-c(-6,0, 6)   # from back trasfrom choos nice label number
yn4<-log(abs(yn3)+1)        # get new locations from nice number
yn4[yn3<0]<-yn4[yn3<0]*-1

chla_sstch<-chla_sstch+ggpubr::rremove("grid")+
    scale_x_continuous(breaks=g_num, labels=g_lab) +  # change x axis
    scale_y_continuous(breaks=yn4, labels=yn3)  

#########   pam  -- 2 var
### svel_linear_change
pam_sstch<-sjPlot::plot_model(pam_stat, type = "pred", terms = "svel_linear_change", title="",
                       axis.title = list("SST change (°C per decade)", "Effect size"))   # , show.data=TRUE
DMwR::unscale(c(-1,1,3), chla_dat$svel_linear_change)
g_lab<-c(0.1,0.2,0.3)
g_num<- (g_lab - mean(pam_dat$vel_linear_change, na.rm=T)) / sd(pam_dat$vel_linear_change, na.rm=T) 
yn<-c(-0.5,0,0.5)  # from yaxis
yn2<-exp(abs(yn)) -1 # back transform  log(12)  hist(sym_dat$yilog)    exp(2.5) -15
yn3<-c(-0.6,0, 0.6)   # from back trasfrom choos nice label number
yn4<-log(abs(yn3)+1)        # get new locations from nice number
yn4[yn3<0]<-yn4[yn3<0]*-1
       # get new locations from nice number
pam_sstch<-pam_sstch+ggpubr::rremove("grid")+
  scale_x_continuous(breaks=g_num, labels=g_lab) +  # change x axis
    scale_y_continuous(breaks=yn4, labels=yn3)  

## sPresent.Surface.Temperature.Range:ssstanom
pam_int<-sjPlot::plot_model(pam_stat, type = "pred", terms = c("sPresent.Surface.Temperature.Range", "ssstanom"),
                   mdrt.values = "meansd", legend.title="SST anomolies",title="", 
                   show.legend=F, show.data=TRUE, 
                   axis.title = list("SST max (°C)", "Effect size"),
                   colors = c("#74add1","#fee090","#d73027")      )
# xaxis
DMwR::unscale(c(-1,1,3), pam_dat$sPresent.Surface.Temperature.Lt.max)
g_lab<-c(28,30,32)
g_num<- (g_lab - mean(pam_dat$Present.Surface.Temperature.Lt.max, na.rm=T)) / sd(pam_dat$Present.Surface.Temperature.Lt.max, na.rm=T)  
# y axis
yn<-c(-1,0,1)  # from yaxis
yn2<-exp(abs(yn)) -1 # back transform  log(12)  hist(sym_dat$yilog)    exp(2.5) -15
yn3<-c(-1.5,0, 1.5)   # from back trasfrom choos nice label number
yn4<-log(abs(yn3)+1)        # get new locations from nice number
yn4[yn3<0]<-yn4[yn3<0]*-1
#legend 
DMwR::unscale(c(-1,0.04,1.08), pam_dat$ssstanom)
leg_lab<-c(.01,0.17,0.32)
# add legend and fix plot  --- only change r, nothing else
d=data.frame(x1=rep(-0.40,times=3), x2=rep(-0.1,times=3), y1=c(0.8,1.1,1.4), t=c("#74add1","#fee090","#d73027"), 
             r=leg_lab, xm=rep(0.2,times=3))
d$y2<-d$y1+0.25
d$ym<-(d$y1+d$y2)/2
qq<-1
pam_int <-  pam_int+ggpubr::rremove("grid")+
    scale_x_continuous(breaks=g_num, labels=g_lab) +  # change x axis
    scale_y_continuous(breaks=yn4, labels=yn3) +  # change y axis
    annotate("rect", xmin=d$x1, xmax=d$x2, ymin=d$y1, ymax=d$y2, alpha=0.5, fill=d$t)  +
    annotate("segment", x=d$x1, xend=d$x2, y=d$ym, yend=d$ym, colour=d$t)  +
    annotate("text", x=d$xm, y=d$ym, label=d$r, size=3) +
    annotate("text", x=d$x1[1]+0.3, y=d$y2[3]+0.15, label="SST anomolies", size=3) 

#########   resp   -- 2 var
### sPresent.Surface.Temperature.Lt.max
resp_sstm<-sjPlot::plot_model(resp_stat, type = "pred", terms = "sPresent.Surface.Temperature.Lt.max", title="",
                       axis.title = list("SST max (°C per decade)", "Effect size"))   # , show.data=TRUE
DMwR::unscale(c(-2,-0.5,1), resp_dat$sPresent.Surface.Temperature.Lt.max)
g_lab<-c(27,28.5,30)
g_num<- (g_lab - mean(resp_dat$Present.Surface.Temperature.Lt.max, na.rm=T)) / sd(resp_dat$Present.Surface.Temperature.Lt.max, na.rm=T) 
yn<-c(-1,-0.25,0.5)  # from yaxis
yn2<-exp(abs(yn)) -1 # back transform  log(12)  hist(sym_dat$yilog)    exp(2.5) -15
yn3<-c(-1.5, -0.75 ,0, 0.75)   # from back trasfrom choos nice label number
yn4<-log(abs(yn3)+1)        # get new locations from nice number
yn4[yn3<0]<-yn4[yn3<0]*-1
       # get new locations from nice number
resp_sstm<-resp_sstm+ggpubr::rremove("grid")+
  scale_x_continuous(breaks=g_num, labels=g_lab) +  # change x axis
    scale_y_continuous(breaks=yn4, labels=yn3)  

###  scoral_region_coral_richness
resp_cr<-sjPlot::plot_model(resp_stat, type = "pred", terms = "scoral_region_coral_richness", title="",
                       axis.title = list("Coral species richness", "Effect size"))   # , show.data=TRUE
DMwR::unscale(c(-0.5,0.75,2), resp_dat$scoral_region_coral_richness)
g_lab<-c(150,300,450)
g_num<- (g_lab - mean(resp_dat$coral_region_coral_richness, na.rm=T)) / sd(resp_dat$coral_region_coral_richness, na.rm=T) 
yn<-c(-1,-0.25,0.5)  # from yaxis
yn2<-exp(abs(yn)) -1 # back transform  log(12)  hist(sym_dat$yilog)    exp(2.5) -15
yn3<-c(-1.5, -0.75 ,0, 0.75)   # from back trasfrom choos nice label number
yn4<-log(abs(yn3)+1)        # get new locations from nice number
yn4[yn3<0]<-yn4[yn3<0]*-1
       # get new locations from nice number
resp_cr<-resp_cr+ggpubr::rremove("grid")+
  scale_x_continuous(breaks=g_num, labels=g_lab) +  # change x axis
    scale_y_continuous(breaks=yn4, labels=yn3)  


```



## data_project

```{r data_project, eval=FALSE, include=FALSE}
## combine data previously separated and get unique locations
##   remove ????
data_u<-rbind(sdat_abu,sdat_div,sdat_ind)
data1<- data_u %>% 
  #dplyr::select(latitude..decimal.degrees., longitude..decimal.degrees., yi) %>% 
  dplyr::group_by(latitude..decimal.degrees., longitude..decimal.degrees.) %>% 
  summarize(mean_yi=mean(mean_yi)) %>% 
  mutate(yi_color = as.character(cut(mean_yi, breaks=c(-Inf,lnn, Inf), labels=rg_color)))
coordinates(data1) <- cbind(data1$longitude..decimal.degrees. , data1$latitude..decimal.degrees.)
proj4string(data1) = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")


```


## indep_layers_fig1

```{r fig_1}
base_color<-"grey75"
xlonlab<-c(-120,-60,0,60,120)
baseylim<-c(-35,35) # limit latitude
ylonlab<-c(-25,0,25)

expand_size<-2  # increase to make shape bigger

#  dev.off()
##  make baser ma;
base_map<-ggplot() + 
  geom_sf(data = base_sf, color = NA, fill = base_color)   # names(base)
  #coord_sf(xlim = c(-180, 180),ylim = baseylim, label_axes=list(bottom = "E", left = "N")) +
  #theme_bw() +
  #theme(panel.grid.major = element_line(colour = "transparent"), panel.grid.minor = element_blank())
  # scale_y_continuous(breaks=ylonlab, labels=ylonlab)

#### richenss coral
legend_title<-"Coral richness"
  c_rich<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = coral_region_coral_richness, color = coral_region_coral_richness), size=expand_size) +
    scale_fill_gradient2(legend_title, low="#FFFFCC",high="#BD0026", mid="orange", midpoint=250,na.value = "transparent") +
    scale_color_gradient2(legend_title, low="#FFFFCC",high="#BD0026", mid="orange", midpoint=250,na.value = "transparent") +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank())

 #### SST range   #   names(coral_map_simp1)    
legend_title<-"SST range"   
sst_r<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = Present.Surface.Temperature.Range.asc11, color = Present.Surface.Temperature.Range.asc11), size=expand_size) +
    scale_fill_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=2.5, na.value = "transparent", trans="sqrt") +  # blue ,yellow, red
    scale_color_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=2.5, na.value = "transparent", trans="sqrt") +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank())
  
##  SST max
legend_title<-"SST max"   
sst_max<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = Present.Surface.Temperature.Lt.max.asc11, color = Present.Surface.Temperature.Lt.max.asc11), size=expand_size) +
    scale_fill_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=29, na.value = "transparent") +  # blue ,yellow, red
    scale_color_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=29, na.value = "transparent") +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank())

##  sstanom
legend_title<-"SST anom"   
sst_anom<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = sstanom, color = sstanom), size=expand_size) +
    scale_fill_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=0.3, na.value = "transparent") +  
    scale_color_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=0.3, na.value = "transparent") +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank())

## linear_change_temp
legend_title<-"SST change"   
sst_ch<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = linear_change_temp, color = linear_change_temp), size=expand_size) +
    scale_fill_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=0.18, na.value = "transparent") + 
    scale_color_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=0.18, na.value = "transparent") +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank())

### human density    # msec_humanpop_50km
legend_title<-"Human den."   
br<-c(5,500,50000)
leg_lab<-br

human<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = msec_humanpop_50km, color = msec_humanpop_50km), size=expand_size) +
    scale_fill_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC",  na.value = "transparent", trans="log",
                         breaks = br, labels = leg_lab) +  # blue ,yellow, red
    scale_color_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC",  na.value = "transparent", trans="log",
                          breaks = br, labels = leg_lab) +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) 
    #theme(axis.text.x = element_blank())

##  combine into one
ll<-LETTERS[1:6]

fig<- ggpubr::ggarrange(change_legend(sst_r), change_legend(sst_max), change_legend(sst_anom), change_legend(sst_ch), change_legend(c_rich), change_legend(human), nrow=6, labels=ll, font.label=list(size = 9), hjust = -1.8, vjust=1.3)

fig2<- ggpubr::annotate_figure(fig, bottom = "Longitude", left = "Latitude"  )
#  dev.off()
fig2

 ggsave(filename="ind_layers_fig1.pdf", plot = fig2 , path = fig_file, width = 17, height = 23, units = c("cm"))


```


## effect_layer_fig2
start next plot of maps of data points colored by effect size
```{r effect_fig}
#   names(dat2)
##################################################
####################    make maps
#####   prep for plot
base_color<-"grey75"
xlonlab<-c(-120,-60,0,60,120)
baseylim<-c(-35,35) # limit latitude
ylonlab<-c(-25,0,25)
legend_title<-"Sensitivity (AE)"  #      names(coral_map_simp1)
expand_size<-1.8  # increase to make shape bigger
str_size<-0.8  # stroke size, increse width of line of shape
leg_br<-c(-2,0,2,4)  # breaks for legend
leg_lab<-leg_br  #  legend labels
leg_lim<-c(-2.75,4.75)  # legend limits
leg_mid<-0
jit<-4
low_col<- "seagreen" # low color for color pallette   - "#144C85"- dark blue
mid_col<- "#FFFFCC"
hig_col<- "#BD0026"

leg_br<-c(-2,0,2)  # breaks for legend
leg_lab<-leg_br  #  legend labels
leg_lim<-c(-2.75,2.75)  # legend limits
leg_mid<-0


##  make base map  hist(dat2$yi)
#########################################################################################
#### warm all
warm_es<-
  base_map + 
  geom_point(data = dat2, aes(x=longitude..decimal.degrees., y=latitude..decimal.degrees., color = yi), shape= 1, stroke = str_size, size=expand_size, alpha=0.5, position = position_jitter(width = jit, height = jit) ) +  # names(base)  
    scale_color_gradient2(legend_title, low=low_col, high=hig_col, mid=mid_col, midpoint=leg_mid, na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank(),axis.title.x=element_blank(),axis.title.y=element_blank())

cat_es<-
  base_map + 
  geom_point(data = dat_cat, aes(x=longitude..decimal.degrees., y=latitude..decimal.degrees., color = yi), shape= 1, stroke = str_size, size=expand_size, alpha=0.5, position = position_jitter(width = jit, height = jit) ) +  # names(base)  
    facet_grid(rows = vars(variable.label.fix.2), space = "fixed", scales = "fixed" ) +  # 
    scale_color_gradient2(legend_title, low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid, na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous("Longitude", breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.title.y=element_blank(),legend.position="none")

### combine
ll<-LETTERS[1:2]
fig_m<- ggpubr::ggarrange(change_legend(warm_es) + theme(plot.margin = unit(c(0.0,0.5,0.0,0), "lines"), 
                                                         axis.ticks.x=element_blank()  )  +
                                      guides(color = guide_colourbar(barwidth = 0.9, barheight = 4.5)),
                          cat_es,
                          nrow=2, heights = c(0.98,6),
                          labels=ll, font.label=list(size = 9), hjust = -1.8, vjust=1.3)

fig_m<- ggpubr::annotate_figure(fig_m, left = "Latitude" )

plot(fig_m)

ggsave(filename="effect_size_lay_fig2.pdf", plot = fig_m, path = fig_file, width = 20, height = 28, units = c("cm"))

```


## combine_model_sig_fig3
 from stats plot warm stats pot cat for actual ggplot production
```{r fig_3}

ll<-LETTERS[1:6]

fig_stat<- ggpubr::ggarrange(change_legend(warm_int)+ theme(axis.title.y=element_blank()), 
                        change_legend(chla_sstch)+ theme(axis.title.y=element_blank()), 
                        change_legend(pam_sstch)+ theme(axis.title.y=element_blank()), 
                        change_legend(pam_int)+ theme(axis.title.y=element_blank()), 
                        change_legend(resp_sstm)+ theme(axis.title.y=element_blank()), 
                        change_legend(resp_cr)+ theme(axis.title.y=element_blank()), 
                        nrow=3, ncol=2, labels=ll, font.label=list(size = 9), hjust = -1.8, vjust=1.3)

fig_stat<- ggpubr::annotate_figure(fig_stat, left = "Sensitivity (AE)"  )
#  dev.off()


 ggsave(filename="model_output_fig3.pdf", plot = fig_stat , path = fig_file, width = 21, height = 23, units = c("cm"))

```


## predict_layer_box_fig4
plot maps of predicted Sensitivity from characterisitcs with significant variavles
then boxplots, code is boxplots first then maps
```{r pred_fig}
#### fig 4 in manuscript

#######################################################################################################
#######   start plotting for figure predict figure

coral_map_R<- coral_map %>% 
  filter(!REALM=="") %>% 
  mutate(REALM=as.factor(REALM)) %>% 
  mutate(REALM=factor(REALM, levels=c("Eastern Indo-Pacific","Tropical Eastern Pacific","Tropical Atlantic",
                            "Western Indo-Pacific" ,"Temperate Northern Pacific","Central Indo-Pacific","Temperate Australasia"))) %>% 
  mutate(REALM = forcats::fct_recode(REALM, "C. Indo-Pacific"="Central Indo-Pacific","E. Indo-Pacific"="Eastern Indo-Pacific"
                      ,"Temp. Australasia"="Temperate Australasia" ,"Temp. N. Pacific"="Temperate Northern Pacific"
                      ,"Trop. Atlantic"="Tropical Atlantic","Trop. E. Pacific"="Tropical Eastern Pacific"
                                           ,"W. Indo-Pacific"="Western Indo-Pacific") )  %>% 
  filter(complete.cases(warm_all_predict))

cc1<-c('#543005','#8c510a','#bf812d','#dfc27d','#f6e8c3','#c7eae5','#80cdc1','#35978f','#01665e','#003c30')
 cc1<-c('#543005','#8c510a','#bf812d','#dfc27d','#80cdc1','#35978f','#003c30')
 cc1<-rep("grey40", 7)
 # boxplot limits
 bp_lim<-c(-4,4)
  bp_br<-c(-3,0,3)
 bp_lab<-c(-3,0,3)
 
 #######################################################################
 #####    Box plots
 warm_bp<-
  ggplot(coral_map_R, aes(x = REALM, y = warm_all_predict_yi, colour=REALM)) +
  geom_boxplot(aes(), size = 0.6, outlier.shape = NA) +
  stat_summary(fun.y=mean, geom="point", shape=1, size=2, colour=cc1) +
  #facet_grid(fac1~fac, space = "fixed", scales="free") +  # , scales = "fixed"
  scale_y_continuous(minor_breaks=NULL,breaks=bp_br,labels = bp_lab, limits = bp_lim, expand = c(0,0)) +  #, limits = c(0, NA)
  scale_color_manual(values=cc1) +
  #scale_shape(solid=FALSE) +
  #labs(y = "Effect size", x = "Eco Realm")  +
  theme_bw()  + # classic -no grids or bw or minimal
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) + # 
  theme(legend.position="none", panel.grid.major = element_blank() )

pam_bp<-
  ggplot(coral_map_R, aes(x = REALM, y = pam_predict_yi, colour=REALM)) +
   geom_boxplot(aes(), size = 0.6, outlier.shape = NA) +
  stat_summary(fun.y=mean, geom="point", shape=1, size=2, colour=cc1) +
  scale_y_continuous(minor_breaks=NULL,breaks=bp_br,labels = bp_lab, limits = bp_lim, expand = c(0,0)) +  #, limits = c(0, NA)
  scale_color_manual(values=cc1) +
  theme_bw()  + # classic -no grids or bw or minimal
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) + # 
  theme(legend.position="none", panel.grid.major = element_blank() )
 
 resp_bp<-
  ggplot(coral_map_R, aes(x = REALM, y = resp_predict_yi, colour=REALM)) +
   geom_boxplot(aes(), size = 0.6, outlier.shape = NA) +
  stat_summary(fun.y=mean, geom="point", shape=1, size=2, colour=cc1) +
  scale_y_continuous(minor_breaks=NULL,breaks=bp_br,labels = bp_lab, limits = bp_lim, expand = c(0,0)) +  #, limits = c(0, NA)
  scale_color_manual(values=cc1) +
  theme_bw()  + # classic -no grids or bw or minimal
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) + # 
  theme(legend.position="none", panel.grid.major = element_blank() )
 
 chla_bp<-
  ggplot(coral_map_R, aes(x = REALM, y = chla_predict_yi, colour=REALM)) +
   geom_boxplot(aes(), size = 0.6, outlier.shape = NA) +
  stat_summary(fun.y=mean, geom="point", shape=1, size=2, colour=cc1) +
  scale_y_continuous(minor_breaks=NULL,breaks=bp_br,labels = bp_lab, limits = bp_lim, expand = c(0,0)) +  #, limits = c(0, NA)
  scale_color_manual(values=cc1) +
  theme_bw()  + # classic -no grids or bw or minimal
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) + # 
  theme(legend.position="none", panel.grid.major = element_blank() )
##################################################
####################    maps
#####   prep for plot
base_color<-"grey75"
xlonlab<-c(-120,-60,0,60,120)
baseylim<-c(-35,35) # limit latitude
ylonlab<-c(-25,0,25)
legend_title<-"Sensitivity (AE)"  #      names(coral_map_simp1)
expand_size<-2  # increase to make shape bigger
leg_br<-c(-2,0,2)  # breaks for legend
leg_lab<-leg_br  #  legend labels
leg_lim<-c(-2.75,2.75)  # legend limits
leg_mid<-0
low_col<- "seagreen" # low color for color pallette   - "#144C85"- dark blue
mid_col<- "#FFFFCC"
hig_col<- "#BD0026"

##  make base map
base_map<-ggplot() + 
  geom_sf(data = base_sf, color = NA, fill = base_color)   # names(base)
  #coord_sf(xlim = c(-180, 180),ylim = baseylim, label_axes=list(bottom = "E", left = "N")) +
  #theme_bw() +
  #theme(panel.grid.major = element_line(colour = "transparent"), panel.grid.minor = element_blank())
  # scale_y_continuous(breaks=ylonlab, labels=ylonlab)
  #  dev.off()
###  plot
#########################################################################################
#### warm all
  wp<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = warm_all_predict_yi, color = warm_all_predict_yi), size=expand_size) +
    scale_fill_gradient2(legend_title, low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid, na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    scale_color_gradient2(legend_title, low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid,na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank())
#### chla  -1.5 to 3
chlap <-base_map +
    geom_sf(data = coral_map_simp1, aes(fill = chla_predict_yi, color = chla_predict_yi), size=expand_size )  +
 scale_fill_gradient2(legend_title,low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid, na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    scale_color_gradient2(legend_title,low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid,na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank())
#### resp  -4 to 4
resp <-base_map +
    geom_sf(data = coral_map_simp1, aes(fill = resp_predict_yi, color = resp_predict_yi), size=expand_size )  +
 scale_fill_gradient2(legend_title,low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid, na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    scale_color_gradient2(legend_title,low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid,na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank())
#### pam  pp  -3 to 3
pamp <-base_map +
    geom_sf(data = coral_map_simp1, aes(fill = pam_predict_yi, color = pam_predict_yi), size=expand_size )  +
 scale_fill_gradient2(legend_title,low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid, na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    scale_color_gradient2(legend_title,low=low_col,high=hig_col, mid=mid_col, midpoint=leg_mid,na.value = "transparent",
                         limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(name="Longitude", breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) 
    #theme(axis.text.x = element_blank())

#########################################################################
##  combine into one
## maps
ll<-LETTERS[1:4]
fig_m<- ggpubr::ggarrange(change_legend(wp), 
                          change_legend(chlap)+theme(legend.position="none"),
                          change_legend(resp)+theme(legend.position="none"),
                          change_legend(pamp)+theme(legend.position="none"),
                          nrow=4, heights = c(1,1,1,1.17),
                          labels=ll, font.label=list(size = 9), hjust = -1.8, vjust=1.3)
fig_m<- ggpubr::annotate_figure(fig_m,left = "Latitude"  )
## boxplots
ll<-LETTERS[5:8]
fig_b<- ggpubr::ggarrange( warm_bp + theme(axis.text.x = element_blank(), axis.title.x=element_blank(),
                                           axis.title.y=element_blank()),
                           chla_bp+ theme(axis.text.x = element_blank(), axis.title.x=element_blank(), 
                                          axis.title.y=element_blank() ),
                           resp_bp +theme(axis.title.y=element_blank(), axis.title.x=element_blank()),
                           pam_bp+ theme(axis.title.y=element_blank(), axis.title.x=element_blank() ), 
                           nrow=2, ncol=2, labels=ll, font.label=list(size = 9), hjust = -1.8, vjust=1.3,
                           heights = c(.65,1))
fig_b<- ggpubr::annotate_figure(fig_b,left = "Effect size"  )

fig_c<- ggpubr::ggarrange( fig_m, fig_b, nrow=2 , heights = c(1,.6))  # 

#fig_d<- ggpubr::annotate_figure(fig, bottom = "Coral reef realm", left = "Latitude"  )
#  dev.off()

fig_c
ggsave(filename="pred_lay_box_fig4.pdf", plot = fig_c, path = fig_file, width = 20, height = 28, units = c("cm"))


```


## future_fig5
4 plots show lt max difference, Susceptibility (2050) and boxplots (2050 and 2100) of coral realms
```{r future_fig}
##   hist(coral_map_simp1$ltmax_change_2050)
## change ltmax to 2050
legend_title<-"SSTmax change"    # "ΔSST max"
leg_mid<-0.8
  ltm_2050<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = ltmax_change_2050, color = ltmax_change_2050), size=expand_size) +
    scale_fill_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC", midpoint=leg_mid, na.value = "transparent") +
    scale_color_gradient2(legend_title, low="#1874CD",high="#BD0026", mid="#FFFFCC",midpoint=leg_mid, na.value = "transparent") +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) +
    theme(axis.text.x = element_blank() )
  
## Susceptibility
legend_title="Susceptibility"
leg_br<-c(-2,0,2)  # breaks for legend
leg_lab<-c("low","med","high")  #  legend labels
leg_lim<-c(-2.75,2.75)  # legend limits
leg_mid<-0  # hist(coral_map_simp1$vuln_2050)
  sensi<- base_map +
    geom_sf(data = coral_map_simp1, aes(fill = vuln_2050, color = vuln_2050), size=expand_size) +
    scale_fill_gradient2(legend_title, low="seagreen",high="#BD0026", mid="#FFFFCC", midpoint=leg_mid, na.value = "transparent", limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    scale_color_gradient2(legend_title, low="seagreen",high="#BD0026", mid="#FFFFCC", midpoint=leg_mid,na.value = "transparent", limits=leg_lim, breaks=leg_br, labels=leg_lab ) +
    coord_sf(xlim = c(-180, 180),ylim = baseylim, expand=FALSE) +
    scale_x_continuous(breaks = xlonlab, labels= xlonlab) +
    scale_y_continuous(breaks = ylonlab, labels= ylonlab) 

## 2 boxplots of realms    vuln_2050
 bp_lim<-c(-4,4) 
 vuln_2050_bp<-
  ggplot(coral_map_R, aes(x = REALM, y = vuln_2050, colour=REALM)) +
   geom_boxplot(aes(), size = 0.6, outlier.shape = NA) +
  stat_summary(fun.y=mean, geom="point", shape=1, size=2, colour=cc1) +
  scale_y_continuous(minor_breaks=NULL, limits = bp_lim, expand = c(0,0)) +  #, limits = c(0, NA)
  scale_color_manual(values=cc1) +
  theme_bw()  + # classic -no grids or bw or minimal
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) + # 
  theme(legend.position="none", panel.grid.major = element_blank() )
 
 vuln_2100_bp<-
  ggplot(coral_map_R, aes(x = REALM, y = vuln_2100, colour=REALM)) +
   geom_boxplot(aes(), size = 0.6, outlier.shape = NA) +
  stat_summary(fun.y=mean, geom="point", shape=1, size=2, colour=cc1) +
  scale_y_continuous(minor_breaks=NULL, limits = bp_lim, expand = c(0,0)) +  #, limits = c(0, NA)
  scale_color_manual(values=cc1) +
  theme_bw()  + # classic -no grids or bw or minimal
  theme(axis.text.x=element_text(angle=45, hjust=1, vjust=1)) + # 
  theme(legend.position="none", panel.grid.major = element_blank() )

#########################################################################
##  combine into one
 ##   !! make sure A legend has blue to red unknown error -Nov 20 2019, if yes run ltm_2050 again ??????
## maps
ll<-LETTERS[1:2]
fig_5m<- ggpubr::ggarrange(change_legend(ltm_2050), 
                          change_legend(sensi),
                          nrow=2, heights = c(1,1.17),
                          labels=ll, font.label=list(size = 9), hjust = -1.8, vjust=1.3)
fig_5m2<- ggpubr::annotate_figure(fig_5m, left = "Latitude" , bottom="Longitude" )
## boxplots
ll<-LETTERS[3:4]
fig_b<- ggpubr::ggarrange( vuln_2050_bp + theme(axis.title.x=element_blank(),
                                           axis.title.y=element_blank()),
                           vuln_2100_bp+ theme(axis.title.y=element_blank(), axis.title.x=element_blank() ), 
                           nrow=1, ncol=2, labels=ll, font.label=list(size = 9), hjust = 0, vjust=1.3)

fig_b<- ggpubr::annotate_figure(fig_b,left = "Susceptibility"  )

fig_c<- ggpubr::ggarrange( fig_5m2, fig_b, nrow=2 , heights = c(1,1))  # 

#  dev.off()
fig_c
ggsave(filename="future_lay_box_fig5.pdf", plot = fig_c, path = fig_file, encoding="MacRoman", width = 20, height = 20, units = c("cm"))

```









