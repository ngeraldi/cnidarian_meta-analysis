---
title: "cnidarian_meta-analysis_statistics"
author: "Nathan R. Geraldi"
date: "November 12, 2019"
output: github_document
---


Script is ot run the statisical analysis of the cnidarian data
it uses the metafor package
It also estimates change with RCP porojections
And estimates what changes in temp or CO2 are needed for impacts


## libraries
```{r Libraries}

library(tidyverse)
library("metafor")
library("Rmisc")
library("plotrix")
library("tiff")

```

## functions
```{r_func}


```

## universal variables
```{r directory}
## file that has data
dat_file="/Users/geraldn/Dropbox/Cnidaria meta-data/data/"
#  also in  dat_file="/Users/geraldn/Dropbox/Documents/KAUST/global change meta/R/export/"

## file to save data
save_file="/Users/geraldn/Dropbox/Cnidaria meta-data/data/"
##  shared file to save data
save_file_shared="/Users/geraldn/Dropbox/Cnidaria meta-data/data/"


```

## get data
meta-analysis data and others
```{r data}

dat<-read.table(paste(dat_file,"meta-analysis_used_data.csv",sep="" ), sep=",",header=T)   ## na
# names(dat)
```


## tidy data
keep only calcyfying corals and remove deep sea corals
```{r tidy_dat}

 sdat<- dat %>% #  names(sdat)   names(dat)   unique(dat$Deep.sea.)
   filter(Taxa_catagory=="Calcifying coral")  %>%  ##  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   filter(Deep.sea.=="No" | is.na(Deep.sea.))  %>% 
   mutate(temp_change=Experimental_temp.level.degrees-Control_temp.level.degrees) %>% 
   mutate(co2_change=Experimental_pCO2.level.µatm-Control_pCO2.level.µatm)

   
```


## setup fro meta-analysis
```{r meta_setup}

# make blank dataframe to input stat results
op <- data.frame(Estimate=integer(),
                 SE=integer(),
                 zval=integer(),
                 pval=integer(),
                 ci.lb=integer(),
                 ci.ub=integer(),
                 stressor=character(),
                 variable=character(),
                 response=character(),
                 sample_size=integer(),
                 stringsAsFactors=FALSE)

#  set up variables and maximium AE
maxyi<-20  # code will remove the absolute value greater than this, removes very few but these are HUGE AE outlyers that make now logical sense

s_stud<-levels(sdat$Stressor.studied) 
resp<-levels(sdat$Trait.type)

#   names(sdat)
```

## meta-analysis
runs loop to run all catagory combinations - warming and/or CO2 manipulations (s_stud) and response trait measured (resp)
puts results into table
```{r meta-analysis}
###### start looop   ######
w<-1

for (j in c(1,2)) {   # for stressor
  
 # tryCatch({
  
    if (j==1) {
       sdat$yi<-sdat$temp_AE # !!!!!!! check which one  !!!!!!!!!!!
       sdat$vi<-sdat$temp_AE_variation
       sdat$change<-sdat$temp_change
       s_stud2 <-s_stud[c(3,2)]
       minchange<-0.5 # set this to filer out any temp change < minchange - difference between experimental and control
       qqq<-"temperature"
    } else {
       #sdat$yi<-sdat$AE_9eV_CO2ppm  #  class(sdat$yi)  names(sdat)
       sdat$yi<-sdat$CO2_AE
        sdat$vi<-sdat$CO2_AE_variation
        sdat$change<-sdat$co2_change
        s_stud2<-s_stud[1:2]
        minchange<-50  # set this to filer out any CO2 change < minchange - difference between experimental and control
        qqq<-"CO2"}
  
  for ( h in c(1,2)) {
      target<-s_stud2[h]

  for (i in c(1:length(resp))) {  # for diffreent catagories  i<-1
    #    target<-"warming"  #    names(sdat)
      sdat2 <- sdat %>% 
        filter(Stressor.studied==target & complete.cases(Stressor.studied)) %>% 
        filter(Trait.type==resp[i])  %>% 
        filter(change > minchange)  %>%    # 
        filter(abs(yi)<= maxyi) %>%  #   hist(sdat$AE_9eV_temp)

        dplyr::select(yi,vi,PROVINCE,Reference.ID,Genus) %>% 
        drop_na() %>% 
        filter(is.finite(vi))  %>% 
        filter(complete.cases(yi))  %>% 
        filter(!is.infinite(yi)) 
      
    #run model with each pub per species   
            m1<-rma.mv(yi,vi,random=list(~1 | Reference.ID, ~1 | Genus),
           data=sdat2, method="ML") 

            funnel(m1, level=c(95), shade=c("white", "gray", "darkgray"), refline=0)
            forest(m1)
            
            
        op[w,1]<-m1$beta  # ESTIMATE  q<-m1$beta[[1]]  op[1,1]<-q
        op[w,2]<-m1$se   # $SE
        op[w,3]<-m1$zval  # 
        op[w,4]<-m1$pval  # 
        op[w,5]<-m1$ci.lb   # 
        op[w,6]<-m1$ci.ub  # $S
        op[w,4]<-m1$pval  # 
        op[w,5]<-m1$ci.lb   # 
        op[w,6]<-m1$ci.ub  
        op[w,7]<-target
        op[w,8]<-resp[i]
        op[w,9]<-qqq
        op[w,10]<-length(row.names(sdat2))

      w<-w+1
  }
  }
 #  }, error=function(e){})
}

```



## meta diagnositcs
some code to check for biases and outliers

```{r meta_diag}

sdat$yi<-sdat$AE_9eV_temp_pos_response # choose effect size metric
sdat$vi<-sdat$AE_9eV_temp_variation
sdat$change<-sdat$temp_change
s_stud2<-s_stud[c(3,2)]
minchange<-0.5 
qqq<-"temperature"
i<-3  # choose resp
h<-1  # choose warming - 1 or both - 2
target<-s_stud2[h]

sdat2 <- sdat %>%  # names(sdat2)
  filter(Stressor.studied==target & complete.cases(Stressor.studied)) %>% 
  filter(variable.label.fix.2.fix_PAM==resp[i])  %>% 
  filter(change > minchange)  %>%    # as suggested by Carlos
  filter(abs(yi)<= maxyi) %>%  #15?  25 works    hist(sdat$AE_9eV_temp)
  
  dplyr::select(yi,vi,PROVINCE,Original.ref.number,genus) %>% 
  drop_na() %>% 
  filter(is.finite(vi))  %>% 
  filter(complete.cases(yi))  %>% 
  filter(!is.infinite(yi)) %>% 
  group_by(Original.ref.number) %>% 
  mutate(study_num = as.character(match(Original.ref.number, unique(Original.ref.number))))  %>%
  ungroup() 


  
sdat2<- sdat2 %>% 
  filter(!(study_num==38))
 # filter(!(study_num==11 |study_num==46))
    

#run model with each pub per species    PROVINCE/
m1<-rma.mv(yi,vi,random=list(~1 | Original.ref.number, ~1 | genus),
           data=sdat2, method="ML")
m1


hist(m1$yi.f)
get_bad<-sdat2 %>% 
  mutate(mod_yi = m1$yi.f) %>% 
  filter (mod_yi>4)


funnel(m1, level=c(95), shade=c("white", "gray", "darkgray"), refline=0)
pp<-forest(m1)



## get summary
mes<-sdat2 %>% 
  group_by(Original.ref.number) %>% 
  mutate(study_num = as.character(match(Original.ref.number, unique(Original.ref.number))))  %>%
  ungroup() %>% 
  group_by(study_num) %>% 
  dplyr::summarise(mean_st = mean(yi)) %>% 
  arrange(desc(mean_st))
```

## RCP projections

```{r rcp_proj}
## make table with rcp's and temp increase
rcp <- data.frame("RCP" = c(2.6,4.0,6.0,8.5), "RCP_temp" = c(1,1.8,2.2,3.7), "RCP_co2"=c(63,173,276,490))
## calulate 
# names(rcp_proj)
    
rcp_proj<- rbind(op,op,op,op) %>% 
  mutate(RCP=rep(rcp$RCP, each=36)) %>% 
  left_join(rcp)  %>%   # join to rcp data
  mutate(rcp_change=if_else(response=="temperature",RCP_temp,RCP_co2)) %>% # make change depending on variable-temp or co2
  mutate(CI=ci.ub-ci.lb) %>% # calc. confidence interval
  # to go from temp to AE used linear realtinoship between difference in 1/kt and difference in degree C use 0.128710787*(temp deg.C)-0.003138539
  mutate(relative_prop=if_else(response=="temperature", -0.128710787*RCP_temp-0.003138539, RCP_co2/100)) %>%  # make relative to change
  mutate(mean_prop_estimate=exp(relative_prop*Estimate)) %>% # get projected mean estimate
  mutate(CI_estimate=((exp(ci.lb*relative_prop))-(exp(ci.ub*relative_prop)))/2) %>% # get project 95% CI
  # calc if CI overlaps with 0
  mutate(Sigificant=if_else( ci.lb > 0,"yes","no"))    # does 95% CI overlap with 0
  
  
  # get mean AE that CI cross zero
 i<-1
 j<-1

  
for (j in c(1:length(op$Estimate))) {
  inc <- 0.1  
  # run until prop_CI_ub_AE is <1
while (prop_CI_ub_AE <= 1) {
print(i)
  
  ## get AE of increase (stepping by 0.1 degree C)
  AE_increm<--0.128710787*inc-0.003138539
  ## add increase to AE estimate from model
  prop_mean_AE<- exp(op$Estimate[j] * AE_increm)
  prop_CI_ub_AE<- exp(op$ci.ub[j] * AE_increm)
# add next step to increase degree C  
inc = inc+0.1

}
  
} 


```


## estimate temp&CO2
calculate temperature or CO@ increase that CI no longer crosses 0 or is significant
```{r est_temp}
op2<-op %>% 
  mutate(temp_increment=-1000,prop_mean_AE=-1000, prop_CI_AE=-1000,  finding="None")
  # get mean AE that CI cross zero
 j<-30
 s<-seq(0.1,10,by=0.1)  # length(s)
 temp_l<-length(s[s<=5]) #length tabel should be if nothing removed
 co2_l<-length(s[s>=1]) 
 s_int<-seq(1,100,by=1)  # length(s_int)
dum <- data.frame("increment" = s+1000, "prop_mean_AE" = s+1000,"prop_CI_AE" = s+1000) 
  

for (j in c(1:length(op2$Estimate))) {
  
  # create table of increase incremental change
  ## TO CHECK need to keep actual seq() in for loop, messes up when use variable name (s10)!!!
  for (i in seq(1,100,by=1)) {
   #  i<-43
  ii<-i/10
  ## add increase to AE estimate from model
  dum$increment[i]<-ii
  ## account for difference in sign between reponses
      if (op2$response[j] == "temperature"){
      ## get AE of increase (stepping by 0.1 degree C)
  KT_increm<- -0.128710787*ii-0.003138539
  dum$prop_mean_AE[i]<- exp(op2$Estimate[j] * KT_increm)
  dum$prop_CI_AE[i]<- exp(op2$ci.lb[j] * KT_increm)  # lower bound for Temp
  
      } else {
  dum$prop_mean_AE[i]<- exp(op2$Estimate[j] * ii) # increments relative to 100 atm (ie 110 uatm = 1.1)
  dum$prop_CI_AE[i]<- exp(op2$ci.ub[j] * ii)  #  upper bound for CO2
              }
  ### for checks, can remove
  #print(i): print(dum$increment[i]): print(KT_increm): print(dum$prop_mean_AE[i]): print(dum$prop_CI_AE[i])
  
  }  # end of dum creation loop
  
  ## created table now check for parameters
  ## first for temp then CO2
  ## for temp
  if (op2$response[j]=="temperature"){
    dum2<-dum[dum$increment<=5,] ## limit findings to increments 0.1 to 5
     # find when prop_CI_ub_AE is <1
    less1<-dum2[dum2$prop_CI_AE <= 1  , ] # set cutoff
    #more1<-dum2[dum2$prop_CI_AE >= 1, ]
  # if prop_CI_AE becomes less than 1 get temp increment -- length(less1)<50 means nothing was removed from table
        if (length(less1$increment) < temp_l & length(less1$increment) > 0){
            outp<-less1[1,] # get first row when become <1
            answerp<-"temp_Significant change see CI for <=1"
        }
  
  
  # if prop_CI_AE is alwasy less than 1 (length of orignial data) it is always significant, but then get temp. increase when prop_meanis < 0.95
        if (length(less1$increment) == temp_l) {
     less_mean_0.95<- dum2[dum2$prop_mean_AE <= 0.95, ]
            if (length(less_mean_0.95$increment) < temp_l & length(less_mean_0.95$increment) >=1) { # check to see if went below 95%
              outp<-less_mean_0.95[1,]
              answerp<-"temp_Sig. CI always<0, see incremnt mean <=95%"
            } else {                          # if never below 95%
              outp<-c(NA,NA,NA)
              answerp<-"temp_Sig. CI always<0, 9%% unknown"
                    }
          } # end of temp inc equal
    
    # if prop_CI_AE alwasy greater than 1 - not sensitive
        if (length(less1$increment) == 0) {
       more_mean_0.95<- dum2[dum2$prop_mean_AE <= 0.95, ]
            if (length(more_mean_0.95$increment) < temp_l & length(more_mean_0.95$increment) >=1) { # check to see if went below 95%
              outp<-more_mean_0.95[1,]
              answerp<-"temp-CI alwasy >1, incremnt mean <=95%"
            } else {                          # if never below 95%
              outp<-c(NA,NA,NA)
              answerp<-"temp-CI alwasy >1, unknown 95%"
                    }
          } # end of temp inc equal
  } #end of temp if
  ##############################
  # for CO2 !!!!!!!!!!!!
  if (op2$response[j]=="CO2"){    
    dum2<-dum[dum$increment>=1,] ## limit findings to increments 1 to 10
    
         # find when prop_CI_ub_AE is <1
  less1<-dum2[dum2$prop_CI_AE <= 1  , ]# set cutoff
  # if prop_CI_AE becomes less than 1 get temp increment -- length(less1)< co2_l means nothing was removed from table
   if (length(less1$increment)< co2_l & length(less_mean_0.95$increment) >=1){
   outp<-less1[1,] # get first row when become <1
   answerp<-"CO2-Sig. change, see CI when it <=1"
      }
  
  # if prop_CI_AE is alwasy less than 1 (length of orignial data) it is always significant, but then get temp. increase when prop_meanis < 0.95
   if (length(less1$increment) == co2_l) {
     less_mean_0.95<- dum2[dum2$prop_mean_AE <= 0.95, ]
     if (length(less_mean_0.95$increment) < co2_l & length(less_mean_0.95$increment) >=1) { # check to see if went below 95%
   outp<-less_mean_0.95[1,]
   answerp<-"CO2-Sig,CI alwasy <1, mean became <=95%"
       } else {                          # if never below 95%
    outp<-c(NA,NA,NA)
    answerp<-"CO2-Sig.CI alwasy <1, mean never"
      }
   } # end of inc
  
      # if prop_CI_AE alwasy greater than 1 - not sensitive
        if (length(less1$increment) == 0) {
       more_mean_0.95<- dum2[dum2$prop_mean_AE <= 0.95, ]
            if (length(more_mean_0.95$increment) < co2_l & length(more_mean_0.95$increment) >=1) { # check to see if went below 95%
              outp<-more_mean_0.95[1,]
              answerp<-"co2-CI alwasy >1, incremnt mean <=95%"
            } else {                          # if never below 95%
              outp<-c(NA,NA,NA)
              answerp<-"co2-CI alwasy >1, unknown 95%"
                    }
          } # end of co2 inc equal
  
  }  #end of co2 if
  
 ###### end of calc
  
  
    #out put to op2
  op2[j,11:13]<-outp
  op2[j,14]<-answerp
  ## clear outp
  outp<-c(222,222,222)
  
  
  
} 

```


## export

```{r export}

#### export meta-analysis summary table to shared folder
    write.table(op, paste(save_file_shared,"meta-analysis_summary_github.csv",sep=""), sep=",",row.names=F)

#### export rcp projection table to shared folder
    write.table(rcp_proj, paste(save_file_shared,"rcp_projections_from_meta.csv",sep=""), sep=",",row.names=F)
    
    #### export meta-analysis summary table to shared folder
    write.table(op2, paste(save_file_shared,"meta-analysis_summary_nov19_with_future.csv",sep=""), sep=",",row.names=F)
```



## desc

```{r desc}

```






